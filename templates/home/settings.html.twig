{% extends 'base.html.twig' %}

{% block title %}StopClope - Param√®tres{% endblock %}

{% block body %}
<div class="container">
    <header class="header">
        <h1>Param√®tres</h1>
    </header>

    <div class="card">
        <h3 style="margin-bottom: 20px;">üéØ Objectif quotidien</h3>

        {% if goal_info %}
        <div style="padding: 15px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span style="font-size: 0.85rem; color: var(--text-secondary);">Palier automatique (dynamique)</span>
                <span style="font-weight: 700; color: var(--success);">{{ goal_info.tier.current_tier }} clopes/jour</span>
            </div>
            <div class="progress-bar" style="height: 8px; margin: 0;">
                {% set tier_progress = goal_info.tier.initial > 0 ? ((goal_info.tier.initial - goal_info.tier.current_tier) / goal_info.tier.initial * 100) : 0 %}
                <div class="progress-fill" style="width: {{ tier_progress }}%; background: linear-gradient(90deg, var(--success), #00ff88);"></div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.75rem; color: var(--text-secondary);">
                <span>D√©but : {{ goal_info.tier.initial }}/jour</span>
                {% if goal_info.tier.next_tier is not null %}
                <span>Prochain : {{ goal_info.tier.next_tier }}/jour</span>
                {% else %}
                <span>üèÜ Objectif z√©ro atteint !</span>
                {% endif %}
            </div>
            {% if goal_info.tier.avg_14d %}
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--bg-primary);">
                <span style="font-size: 0.85rem;">Moyenne 14 jours : </span>
                <span style="font-weight: 600; color: {{ goal_info.tier.avg_14d <= goal_info.tier.current_tier ? 'var(--success)' : 'var(--warning)' }};">
                    {{ goal_info.tier.avg_14d }} clopes/jour
                </span>
                {% if goal_info.tier.avg_14d <= goal_info.tier.current_tier %}
                    <span style="color: var(--success);">‚úì En dessous du palier</span>
                {% endif %}
            </div>
            <div style="margin-top: 8px; font-size: 0.75rem; color: var(--text-secondary);">
                üí° Palier = floor(moyenne) - 1, ne peut jamais monter
            </div>
            {% endif %}
        </div>
        {% endif %}

        <div class="input-group">
            <label for="dailyGoal">Objectif personnalis√© (optionnel)</label>
            <input type="number" id="dailyGoal" min="0" max="50" value="{{ daily_goal ?? '' }}" placeholder="{{ suggested_goal ? 'Ex: ' ~ suggested_goal : 'Laisser vide pour palier auto' }}">
            <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 5px;">
                {% if daily_goal %}
                    Objectif personnalis√© : {{ daily_goal }} clopes/jour
                {% elseif suggested_goal %}
                    üí° Suggestion bas√©e sur ta moyenne : {{ suggested_goal }} clopes/jour
                {% else %}
                    Laisse vide pour utiliser le palier automatique dynamique
                {% endif %}
            </p>
        </div>
    </div>

    <div class="card">
        <h3 style="margin-bottom: 20px;">Calcul des √©conomies</h3>

        <div class="input-group">
            <label for="packPrice">Prix du paquet (‚Ç¨)</label>
            <input type="number" step="0.01" id="packPrice" value="{{ pack_price }}">
        </div>

        <div class="input-group">
            <label for="cigsPerPack">Cigarettes par paquet</label>
            <input type="number" id="cigsPerPack" value="{{ cigs_per_pack }}">
        </div>

        <div class="input-group">
            <label for="initialDailyCigs">Consommation initiale (clopes/jour)</label>
            <input type="number" id="initialDailyCigs" value="{{ initial_daily_cigs }}">
            <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 5px;">
                Ta consommation avant de commencer √† r√©duire
            </p>
        </div>

        <button class="big-button" onclick="saveSettings()" style="margin-top: 20px;">
            Enregistrer
        </button>
    </div>

    <div class="card">
        <h3 style="margin-bottom: 20px;">Rappel r√©veil</h3>

        <div class="input-group">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="wakeupReminderEnabled" style="width: 20px; height: 20px; accent-color: var(--accent);">
                <span>Activer le rappel quotidien</span>
            </label>
            <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 5px;">
                Notification pour ne pas oublier de noter ton r√©veil
            </p>
        </div>

        <div class="input-group" id="reminderTimeGroup" style="display: none;">
            <label for="wakeupReminderTime">Heure du rappel</label>
            <input type="time" id="wakeupReminderTime" value="08:00">
        </div>

        <div id="notificationStatus" style="padding: 10px; border-radius: 8px; font-size: 0.85rem; margin-top: 10px;"></div>
    </div>

    <div class="card">
        <h3 style="margin-bottom: 15px;">Exporter mes donn√©es</h3>
        <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 15px;">
            T√©l√©charge toutes tes donn√©es pour les sauvegarder ou les partager avec un professionnel de sant√©.
        </p>
        <div style="display: flex; gap: 10px;">
            <a href="{{ path('app_export_csv') }}" class="secondary-button" style="flex: 1; text-align: center; text-decoration: none;">
                üìä Export CSV
            </a>
            <a href="{{ path('app_export_json') }}" class="secondary-button" style="flex: 1; text-align: center; text-decoration: none;">
                üìÅ Export JSON
            </a>
        </div>
    </div>

    <div class="card">
        <h3 style="margin-bottom: 20px;">üé® Apparence</h3>

        <div class="input-group">
            <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                <span>Mode clair</span>
                <div class="theme-toggle" id="themeToggle">
                    <input type="checkbox" id="themeSwitch" style="display: none;">
                    <div class="toggle-track">
                        <div class="toggle-thumb"></div>
                    </div>
                </div>
            </label>
            <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 5px;">
                Par d√©faut : suit les pr√©f√©rences syst√®me
            </p>
        </div>

        <div class="input-group" style="margin-top: 20px;">
            <label for="fontSizeSelect">Taille du texte</label>
            <div class="font-size-options" id="fontSizeOptions">
                <button type="button" class="font-size-btn" data-size="small">A</button>
                <button type="button" class="font-size-btn" data-size="normal">A</button>
                <button type="button" class="font-size-btn" data-size="large">A</button>
                <button type="button" class="font-size-btn" data-size="xlarge">A</button>
            </div>
        </div>
    </div>

    <div class="card">
        <h3 style="margin-bottom: 15px;">Aide</h3>
        <a href="{{ path('app_onboarding') }}" class="secondary-button" style="display: block; text-align: center; text-decoration: none;">
            Comment √ßa marche ?
        </a>
    </div>

    <a href="{{ path('app_stats') }}" class="secondary-button" style="display: block; text-align: center; text-decoration: none;">
        ‚Üê Retour aux stats
    </a>
</div>

<style>
    .theme-toggle {
        position: relative;
    }

    .toggle-track {
        width: 50px;
        height: 28px;
        background: var(--bg-secondary);
        border-radius: 14px;
        padding: 2px;
        cursor: pointer;
        transition: background 0.3s;
        border: 2px solid var(--accent);
    }

    .toggle-thumb {
        width: 20px;
        height: 20px;
        background: var(--accent);
        border-radius: 50%;
        transition: transform 0.3s;
    }

    .theme-toggle.active .toggle-track {
        background: var(--accent);
    }

    .theme-toggle.active .toggle-thumb {
        transform: translateX(22px);
        background: var(--bg-primary);
    }

    .font-size-options {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }

    .font-size-btn {
        flex: 1;
        padding: 12px;
        border: 2px solid var(--bg-secondary);
        background: var(--bg-secondary);
        color: var(--text-primary);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 600;
    }

    .font-size-btn[data-size="small"] { font-size: 0.8rem; }
    .font-size-btn[data-size="normal"] { font-size: 1rem; }
    .font-size-btn[data-size="large"] { font-size: 1.2rem; }
    .font-size-btn[data-size="xlarge"] { font-size: 1.4rem; }

    .font-size-btn.active {
        border-color: var(--accent);
        background: var(--accent);
        color: var(--bg-primary);
    }

    .font-size-btn:active {
        transform: scale(0.95);
    }
</style>

<script>
    // Get CSRF token for secure requests
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    // ===== Param√®tres serveur =====
    function saveSettings() {
        const packPrice = document.getElementById('packPrice').value;
        const cigsPerPack = document.getElementById('cigsPerPack').value;
        const initialDailyCigs = document.getElementById('initialDailyCigs').value;
        const dailyGoal = document.getElementById('dailyGoal').value;

        fetch('{{ path('app_settings_save') }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRF-Token': csrfToken
            },
            body: `pack_price=${packPrice}&cigs_per_pack=${cigsPerPack}&initial_daily_cigs=${initialDailyCigs}&daily_goal=${dailyGoal}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Param√®tres enregistr√©s', { type: 'success', icon: '‚úÖ' });
                setTimeout(() => window.location.href = '{{ path('app_stats') }}', 1000);
            } else {
                showToast(data.error || 'Erreur lors de l\'enregistrement', { type: 'error' });
            }
        })
        .catch(err => {
            showToast('Erreur r√©seau', { type: 'error' });
        });
    }

    // ===== Notifications locales (rappel r√©veil) =====
    const enabledCheckbox = document.getElementById('wakeupReminderEnabled');
    const timeInput = document.getElementById('wakeupReminderTime');
    const timeGroup = document.getElementById('reminderTimeGroup');
    const statusDiv = document.getElementById('notificationStatus');

    // Charger les param√®tres depuis localStorage
    function loadReminderSettings() {
        const enabled = localStorage.getItem('wakeupReminderEnabled') === 'true';
        const time = localStorage.getItem('wakeupReminderTime') || '08:00';

        enabledCheckbox.checked = enabled;
        timeInput.value = time;
        timeGroup.style.display = enabled ? 'block' : 'none';

        updateNotificationStatus();
    }

    // Mettre √† jour l'affichage du statut
    function updateNotificationStatus() {
        if (!('Notification' in window)) {
            statusDiv.textContent = 'Les notifications ne sont pas support√©es par ce navigateur';
            statusDiv.style.background = 'rgba(233, 69, 96, 0.2)';
            statusDiv.style.color = 'var(--accent)';
            return;
        }

        if (Notification.permission === 'denied') {
            statusDiv.textContent = 'Notifications bloqu√©es. Active-les dans les param√®tres du navigateur.';
            statusDiv.style.background = 'rgba(233, 69, 96, 0.2)';
            statusDiv.style.color = 'var(--accent)';
            return;
        }

        if (enabledCheckbox.checked) {
            if (Notification.permission === 'granted') {
                statusDiv.textContent = 'Rappel activ√© √† ' + timeInput.value;
                statusDiv.style.background = 'rgba(0, 217, 165, 0.2)';
                statusDiv.style.color = 'var(--success)';
            } else {
                statusDiv.textContent = 'Clique pour autoriser les notifications';
                statusDiv.style.background = 'rgba(255, 193, 7, 0.2)';
                statusDiv.style.color = 'var(--warning)';
            }
        } else {
            statusDiv.textContent = 'Rappel d√©sactiv√©';
            statusDiv.style.background = 'var(--bg-secondary)';
            statusDiv.style.color = 'var(--text-secondary)';
        }
    }

    // Demander la permission et programmer le rappel
    async function enableReminder() {
        if (!('Notification' in window)) {
            showToast('Notifications non support√©es');
            enabledCheckbox.checked = false;
            return false;
        }

        if (Notification.permission === 'denied') {
            showToast('Notifications bloqu√©es par le navigateur');
            enabledCheckbox.checked = false;
            return false;
        }

        if (Notification.permission !== 'granted') {
            const permission = await Notification.requestPermission();
            if (permission !== 'granted') {
                showToast('Permission refus√©e');
                enabledCheckbox.checked = false;
                return false;
            }
        }

        localStorage.setItem('wakeupReminderEnabled', 'true');
        localStorage.setItem('wakeupReminderTime', timeInput.value);
        scheduleWakeupReminder();
        showToast('Rappel activ√©');
        return true;
    }

    // D√©sactiver le rappel
    function disableReminder() {
        localStorage.setItem('wakeupReminderEnabled', 'false');
        clearScheduledReminder();
        showToast('Rappel d√©sactiv√©');
    }

    // Programmer le rappel quotidien
    function scheduleWakeupReminder() {
        clearScheduledReminder();

        const enabled = localStorage.getItem('wakeupReminderEnabled') === 'true';
        if (!enabled) return;

        const time = localStorage.getItem('wakeupReminderTime') || '08:00';
        const [hours, minutes] = time.split(':').map(Number);

        const now = new Date();
        const nextReminder = new Date();
        nextReminder.setHours(hours, minutes, 0, 0);

        // Si l'heure est d√©j√† pass√©e aujourd'hui, programmer pour demain
        if (nextReminder <= now) {
            nextReminder.setDate(nextReminder.getDate() + 1);
        }

        const delay = nextReminder.getTime() - now.getTime();

        const timeoutId = setTimeout(() => {
            showWakeupNotification();
            // Reprogrammer pour le lendemain
            scheduleWakeupReminder();
        }, delay);

        localStorage.setItem('wakeupReminderTimeout', timeoutId);
    }

    // Annuler le rappel programm√©
    function clearScheduledReminder() {
        const timeoutId = localStorage.getItem('wakeupReminderTimeout');
        if (timeoutId) {
            clearTimeout(parseInt(timeoutId));
            localStorage.removeItem('wakeupReminderTimeout');
        }
    }

    // Afficher la notification
    function showWakeupNotification() {
        if (Notification.permission === 'granted') {
            const notification = new Notification('StopClope', {
                body: 'N\'oublie pas de noter ton heure de r√©veil !',
                icon: '/icons/icon-192.png',
                badge: '/icons/icon-96.png',
                tag: 'wakeup-reminder',
                requireInteraction: true
            });

            notification.onclick = () => {
                window.focus();
                window.location.href = '/';
                notification.close();
            };
        }
    }

    // Event listeners
    enabledCheckbox.addEventListener('change', async () => {
        if (enabledCheckbox.checked) {
            const success = await enableReminder();
            timeGroup.style.display = success ? 'block' : 'none';
        } else {
            disableReminder();
            timeGroup.style.display = 'none';
        }
        updateNotificationStatus();
    });

    timeInput.addEventListener('change', () => {
        localStorage.setItem('wakeupReminderTime', timeInput.value);
        scheduleWakeupReminder();
        updateNotificationStatus();
        showToast('Heure mise √† jour');
    });

    // Initialisation
    loadReminderSettings();
    scheduleWakeupReminder();

    // ===== Gestion du th√®me =====
    const themeToggle = document.getElementById('themeToggle');
    const themeSwitch = document.getElementById('themeSwitch');

    function loadThemeSettings() {
        const savedTheme = localStorage.getItem('theme');
        const isLight = savedTheme === 'light' ||
            (!savedTheme && window.matchMedia('(prefers-color-scheme: light)').matches);

        if (isLight) {
            themeToggle.classList.add('active');
            themeSwitch.checked = true;
        }
    }

    function toggleTheme() {
        const isLight = themeToggle.classList.toggle('active');
        themeSwitch.checked = isLight;

        if (isLight) {
            document.documentElement.setAttribute('data-theme', 'light');
            localStorage.setItem('theme', 'light');
        } else {
            document.documentElement.setAttribute('data-theme', 'dark');
            localStorage.setItem('theme', 'dark');
        }

        showToast(isLight ? 'Mode clair activ√©' : 'Mode sombre activ√©', { icon: isLight ? '‚òÄÔ∏è' : 'üåô' });
    }

    themeToggle.addEventListener('click', toggleTheme);

    // √âcouter les changements de pr√©f√©rence syst√®me
    window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', (e) => {
        if (!localStorage.getItem('theme')) {
            // Pas de pr√©f√©rence explicite, suivre le syst√®me
            if (e.matches) {
                themeToggle.classList.add('active');
            } else {
                themeToggle.classList.remove('active');
            }
        }
    });

    loadThemeSettings();

    // ===== Gestion de la taille de police =====
    const fontSizeBtns = document.querySelectorAll('.font-size-btn');

    function loadFontSizeSettings() {
        const savedSize = localStorage.getItem('fontSize') || 'normal';
        fontSizeBtns.forEach(btn => {
            if (btn.dataset.size === savedSize) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }

    function setFontSize(size) {
        // Mettre √† jour l'attribut sur le document
        if (size === 'normal') {
            document.documentElement.removeAttribute('data-font-size');
            localStorage.removeItem('fontSize');
        } else {
            document.documentElement.setAttribute('data-font-size', size);
            localStorage.setItem('fontSize', size);
        }

        // Mettre √† jour les boutons
        fontSizeBtns.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.size === size);
        });

        const sizeLabels = { small: 'Petit', normal: 'Normal', large: 'Grand', xlarge: 'Tr√®s grand' };
        showToast(`Taille : ${sizeLabels[size]}`, { icon: 'üî§' });
    }

    fontSizeBtns.forEach(btn => {
        btn.addEventListener('click', () => setFontSize(btn.dataset.size));
    });

    loadFontSizeSettings();
</script>
{% endblock %}
