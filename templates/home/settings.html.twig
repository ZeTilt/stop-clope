{% extends 'base.html.twig' %}

{% block title %}StopClope - Param√®tres{% endblock %}

{% block body %}
<div class="container">
    <header class="header">
        <h1>Param√®tres</h1>
    </header>

    <div class="card">
        <h3 style="margin-bottom: 20px;">üéØ Objectif quotidien</h3>

        {% if goal_info %}
        <div style="padding: 15px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span style="font-size: 0.85rem; color: var(--text-secondary);">Palier automatique (semaine {{ goal_info.tier.weeks_active + 1 }})</span>
                <span style="font-weight: 700; color: var(--success);">{{ goal_info.tier.current_tier }} clopes/jour</span>
            </div>
            <div class="progress-bar" style="height: 8px; margin: 0;">
                {% set tier_progress = goal_info.tier.initial > 0 ? ((goal_info.tier.initial - goal_info.tier.current_tier) / goal_info.tier.initial * 100) : 0 %}
                <div class="progress-fill" style="width: {{ tier_progress }}%; background: linear-gradient(90deg, var(--success), #00ff88);"></div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.75rem; color: var(--text-secondary);">
                <span>D√©but : {{ goal_info.tier.initial }}/jour</span>
                {% if goal_info.tier.next_tier is not null %}
                <span>Prochain palier dans {{ goal_info.tier.days_until_next_tier }}j ‚Üí {{ goal_info.tier.next_tier }}/jour</span>
                {% else %}
                <span>üèÜ Objectif z√©ro atteint !</span>
                {% endif %}
            </div>
            {% if goal_info.current_avg %}
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--bg-primary);">
                <span style="font-size: 0.85rem;">Ta moyenne actuelle : </span>
                <span style="font-weight: 600; color: {{ goal_info.current_avg <= goal_info.tier.current_tier ? 'var(--success)' : 'var(--warning)' }};">
                    {{ goal_info.current_avg }} clopes/jour
                </span>
                {% if goal_info.current_avg <= goal_info.tier.current_tier %}
                    <span style="color: var(--success);">‚úì En dessous du palier</span>
                {% endif %}
            </div>
            {% endif %}
        </div>
        {% endif %}

        <div class="input-group">
            <label for="dailyGoal">Objectif personnalis√© (optionnel)</label>
            <input type="number" id="dailyGoal" min="0" max="50" value="{{ daily_goal ?? '' }}" placeholder="{{ suggested_goal ? 'Ex: ' ~ suggested_goal : 'Laisser vide pour palier auto' }}">
            <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 5px;">
                {% if daily_goal %}
                    Objectif personnalis√© : {{ daily_goal }} clopes/jour
                {% elseif suggested_goal %}
                    üí° Suggestion bas√©e sur ta moyenne : {{ suggested_goal }} clopes/jour
                {% else %}
                    Laisse vide pour utiliser le palier automatique (-1/semaine)
                {% endif %}
            </p>
        </div>
    </div>

    <div class="card">
        <h3 style="margin-bottom: 20px;">Calcul des √©conomies</h3>

        <div class="input-group">
            <label for="packPrice">Prix du paquet (‚Ç¨)</label>
            <input type="number" step="0.01" id="packPrice" value="{{ pack_price }}">
        </div>

        <div class="input-group">
            <label for="cigsPerPack">Cigarettes par paquet</label>
            <input type="number" id="cigsPerPack" value="{{ cigs_per_pack }}">
        </div>

        <div class="input-group">
            <label for="initialDailyCigs">Consommation initiale (clopes/jour)</label>
            <input type="number" id="initialDailyCigs" value="{{ initial_daily_cigs }}">
            <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 5px;">
                Ta consommation avant de commencer √† r√©duire
            </p>
        </div>

        <button class="big-button" onclick="saveSettings()" style="margin-top: 20px;">
            Enregistrer
        </button>
    </div>

    <div class="card">
        <h3 style="margin-bottom: 20px;">Rappel r√©veil</h3>

        <div class="input-group">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="wakeupReminderEnabled" style="width: 20px; height: 20px; accent-color: var(--accent);">
                <span>Activer le rappel quotidien</span>
            </label>
            <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 5px;">
                Notification pour ne pas oublier de noter ton r√©veil
            </p>
        </div>

        <div class="input-group" id="reminderTimeGroup" style="display: none;">
            <label for="wakeupReminderTime">Heure du rappel</label>
            <input type="time" id="wakeupReminderTime" value="08:00">
        </div>

        <div id="notificationStatus" style="padding: 10px; border-radius: 8px; font-size: 0.85rem; margin-top: 10px;"></div>
    </div>

    <div class="card">
        <h3 style="margin-bottom: 15px;">Exporter mes donn√©es</h3>
        <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 15px;">
            T√©l√©charge toutes tes donn√©es pour les sauvegarder ou les partager avec un professionnel de sant√©.
        </p>
        <div style="display: flex; gap: 10px;">
            <a href="{{ path('app_export_csv') }}" class="secondary-button" style="flex: 1; text-align: center; text-decoration: none;">
                üìä Export CSV
            </a>
            <a href="{{ path('app_export_json') }}" class="secondary-button" style="flex: 1; text-align: center; text-decoration: none;">
                üìÅ Export JSON
            </a>
        </div>
    </div>

    <div class="card">
        <h3 style="margin-bottom: 15px;">Aide</h3>
        <a href="{{ path('app_onboarding') }}" class="secondary-button" style="display: block; text-align: center; text-decoration: none;">
            Comment √ßa marche ?
        </a>
    </div>

    <a href="{{ path('app_stats') }}" class="secondary-button" style="display: block; text-align: center; text-decoration: none;">
        ‚Üê Retour aux stats
    </a>
</div>

<script>
    // Get CSRF token for secure requests
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    // ===== Param√®tres serveur =====
    function saveSettings() {
        const packPrice = document.getElementById('packPrice').value;
        const cigsPerPack = document.getElementById('cigsPerPack').value;
        const initialDailyCigs = document.getElementById('initialDailyCigs').value;
        const dailyGoal = document.getElementById('dailyGoal').value;

        fetch('{{ path('app_settings_save') }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRF-Token': csrfToken
            },
            body: `pack_price=${packPrice}&cigs_per_pack=${cigsPerPack}&initial_daily_cigs=${initialDailyCigs}&daily_goal=${dailyGoal}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Param√®tres enregistr√©s', { type: 'success', icon: '‚úÖ' });
                setTimeout(() => window.location.href = '{{ path('app_stats') }}', 1000);
            } else {
                showToast(data.error || 'Erreur lors de l\'enregistrement', { type: 'error' });
            }
        })
        .catch(err => {
            showToast('Erreur r√©seau', { type: 'error' });
        });
    }

    // ===== Notifications locales (rappel r√©veil) =====
    const enabledCheckbox = document.getElementById('wakeupReminderEnabled');
    const timeInput = document.getElementById('wakeupReminderTime');
    const timeGroup = document.getElementById('reminderTimeGroup');
    const statusDiv = document.getElementById('notificationStatus');

    // Charger les param√®tres depuis localStorage
    function loadReminderSettings() {
        const enabled = localStorage.getItem('wakeupReminderEnabled') === 'true';
        const time = localStorage.getItem('wakeupReminderTime') || '08:00';

        enabledCheckbox.checked = enabled;
        timeInput.value = time;
        timeGroup.style.display = enabled ? 'block' : 'none';

        updateNotificationStatus();
    }

    // Mettre √† jour l'affichage du statut
    function updateNotificationStatus() {
        if (!('Notification' in window)) {
            statusDiv.textContent = 'Les notifications ne sont pas support√©es par ce navigateur';
            statusDiv.style.background = 'rgba(233, 69, 96, 0.2)';
            statusDiv.style.color = 'var(--accent)';
            return;
        }

        if (Notification.permission === 'denied') {
            statusDiv.textContent = 'Notifications bloqu√©es. Active-les dans les param√®tres du navigateur.';
            statusDiv.style.background = 'rgba(233, 69, 96, 0.2)';
            statusDiv.style.color = 'var(--accent)';
            return;
        }

        if (enabledCheckbox.checked) {
            if (Notification.permission === 'granted') {
                statusDiv.textContent = 'Rappel activ√© √† ' + timeInput.value;
                statusDiv.style.background = 'rgba(0, 217, 165, 0.2)';
                statusDiv.style.color = 'var(--success)';
            } else {
                statusDiv.textContent = 'Clique pour autoriser les notifications';
                statusDiv.style.background = 'rgba(255, 193, 7, 0.2)';
                statusDiv.style.color = 'var(--warning)';
            }
        } else {
            statusDiv.textContent = 'Rappel d√©sactiv√©';
            statusDiv.style.background = 'var(--bg-secondary)';
            statusDiv.style.color = 'var(--text-secondary)';
        }
    }

    // Demander la permission et programmer le rappel
    async function enableReminder() {
        if (!('Notification' in window)) {
            showToast('Notifications non support√©es');
            enabledCheckbox.checked = false;
            return false;
        }

        if (Notification.permission === 'denied') {
            showToast('Notifications bloqu√©es par le navigateur');
            enabledCheckbox.checked = false;
            return false;
        }

        if (Notification.permission !== 'granted') {
            const permission = await Notification.requestPermission();
            if (permission !== 'granted') {
                showToast('Permission refus√©e');
                enabledCheckbox.checked = false;
                return false;
            }
        }

        localStorage.setItem('wakeupReminderEnabled', 'true');
        localStorage.setItem('wakeupReminderTime', timeInput.value);
        scheduleWakeupReminder();
        showToast('Rappel activ√©');
        return true;
    }

    // D√©sactiver le rappel
    function disableReminder() {
        localStorage.setItem('wakeupReminderEnabled', 'false');
        clearScheduledReminder();
        showToast('Rappel d√©sactiv√©');
    }

    // Programmer le rappel quotidien
    function scheduleWakeupReminder() {
        clearScheduledReminder();

        const enabled = localStorage.getItem('wakeupReminderEnabled') === 'true';
        if (!enabled) return;

        const time = localStorage.getItem('wakeupReminderTime') || '08:00';
        const [hours, minutes] = time.split(':').map(Number);

        const now = new Date();
        const nextReminder = new Date();
        nextReminder.setHours(hours, minutes, 0, 0);

        // Si l'heure est d√©j√† pass√©e aujourd'hui, programmer pour demain
        if (nextReminder <= now) {
            nextReminder.setDate(nextReminder.getDate() + 1);
        }

        const delay = nextReminder.getTime() - now.getTime();

        const timeoutId = setTimeout(() => {
            showWakeupNotification();
            // Reprogrammer pour le lendemain
            scheduleWakeupReminder();
        }, delay);

        localStorage.setItem('wakeupReminderTimeout', timeoutId);
    }

    // Annuler le rappel programm√©
    function clearScheduledReminder() {
        const timeoutId = localStorage.getItem('wakeupReminderTimeout');
        if (timeoutId) {
            clearTimeout(parseInt(timeoutId));
            localStorage.removeItem('wakeupReminderTimeout');
        }
    }

    // Afficher la notification
    function showWakeupNotification() {
        if (Notification.permission === 'granted') {
            const notification = new Notification('StopClope', {
                body: 'N\'oublie pas de noter ton heure de r√©veil !',
                icon: '/icons/icon-192.png',
                badge: '/icons/icon-96.png',
                tag: 'wakeup-reminder',
                requireInteraction: true
            });

            notification.onclick = () => {
                window.focus();
                window.location.href = '/';
                notification.close();
            };
        }
    }

    // Event listeners
    enabledCheckbox.addEventListener('change', async () => {
        if (enabledCheckbox.checked) {
            const success = await enableReminder();
            timeGroup.style.display = success ? 'block' : 'none';
        } else {
            disableReminder();
            timeGroup.style.display = 'none';
        }
        updateNotificationStatus();
    });

    timeInput.addEventListener('change', () => {
        localStorage.setItem('wakeupReminderTime', timeInput.value);
        scheduleWakeupReminder();
        updateNotificationStatus();
        showToast('Heure mise √† jour');
    });

    // Initialisation
    loadReminderSettings();
    scheduleWakeupReminder();
</script>
{% endblock %}
