{% extends 'base.html.twig' %}

{% block title %}StopClope - Accueil{% endblock %}

{% block body %}
<div class="container">
    <header class="header">
        <h1>StopClope</h1>
        <div id="offlineIndicator" style="display: none; background: var(--warning); color: #000; padding: 5px 12px; border-radius: 12px; font-size: 0.75rem; margin-top: 5px;">
            Mode hors-ligne
        </div>
    </header>

    <!-- R√©veil du jour -->
    <div class="card" style="padding: 15px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <span style="color: var(--text-secondary); font-size: 0.85rem;">R√©veil</span>
                <div style="font-size: 1.3rem; font-weight: 600;" id="wakeupDisplay">
                    {% if today_wakeup %}
                        {{ today_wakeup.wakeTime|date('H:i') }}
                    {% else %}
                        --:--
                    {% endif %}
                </div>
            </div>
            <button class="secondary-button" style="width: auto; margin: 0; padding: 10px 15px;{% if not today_wakeup %} background: var(--accent);{% endif %}" onclick="openWakeUpModal()">
                {% if today_wakeup %}Modifier{% else %}Noter le r√©veil{% endif %}
            </button>
        </div>
    </div>

    <!-- C√©l√©bration nouveau palier -->
    {% if tier_achievement.achieved %}
    <div class="card tier-celebration" style="padding: 20px; text-align: center; background: linear-gradient(135deg, #ffd700, #ffec8b); border: 2px solid #ffd700;">
        <div style="font-size: 3rem; margin-bottom: 10px;">üéâ</div>
        <div style="color: #000; font-weight: 700; font-size: 1.2rem;">
            Nouveau palier atteint !
        </div>
        <div style="color: #333; font-size: 1rem; margin-top: 8px;">
            {{ tier_achievement.message }}
        </div>
        {% if tier_achievement.new_tier == 0 %}
        <div style="margin-top: 10px; font-size: 2rem;">üèÜ</div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Message d'encouragement -->
    {% if encouragement %}
    <div class="card" style="padding: 15px; text-align: center; background: {{ encouragement.type == 'success' ? 'linear-gradient(135deg, var(--success), #00ff88)' : 'linear-gradient(135deg, var(--warning), #ffdb4d)' }};">
        <span style="font-size: 1.5rem;">{{ encouragement.icon }}</span>
        <div style="color: #000; font-weight: 600; margin-top: 5px;">
            {{ encouragement.message }}
        </div>
    </div>
    {% endif %}

    <!-- Objectif quotidien -->
    {% if goal_progress %}
    <div class="card" style="padding: 15px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span style="font-size: 0.85rem; color: var(--text-secondary);">üéØ Objectif du jour</span>
            <span style="font-weight: 700; color: {{ goal_progress.exceeded ? 'var(--error)' : (goal_progress.remaining == 0 ? 'var(--warning)' : 'var(--success)') }};">
                {{ goal_progress.current }} / {{ goal_progress.goal }}
            </span>
        </div>
        <div class="progress-bar" style="height: 10px; margin: 0;">
            <div class="progress-fill" style="width: {{ goal_progress.progress_percent }}%; background: {{ goal_progress.exceeded ? 'linear-gradient(90deg, var(--error), #ff6b6b)' : (goal_progress.progress_percent >= 80 ? 'linear-gradient(90deg, var(--warning), #ffdb4d)' : 'linear-gradient(90deg, var(--success), #00ff88)') }};"></div>
        </div>
        <div style="margin-top: 8px; font-size: 0.85rem; text-align: center;">
            {% if goal_progress.exceeded %}
                <span style="color: var(--error);">Objectif d√©pass√© de {{ goal_progress.exceeded_by }} clope{{ goal_progress.exceeded_by > 1 ? 's' : '' }}</span>
            {% elseif goal_progress.remaining == 0 %}
                <span style="color: var(--warning);">‚ö†Ô∏è Objectif atteint, tiens bon !</span>
            {% elseif goal_progress.remaining == 1 %}
                <span style="color: var(--warning);">Plus qu'une clope autoris√©e</span>
            {% else %}
                <span style="color: var(--success);">{{ goal_progress.remaining }} clopes restantes</span>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Score du jour + Streak -->
    <div class="card score-display">
        <div class="score-value {{ daily_score.total_score < 0 ? 'negative' : '' }}">
            {{ daily_score.total_score > 0 ? '+' : '' }}{{ daily_score.total_score }}
        </div>
        <div class="score-label">Points aujourd'hui</div>

        {% if streak.current > 0 %}
        <div style="margin-top: 15px; display: flex; justify-content: center; gap: 20px;">
            <div style="text-align: center;">
                <div style="font-size: 1.5rem; font-weight: 700; color: {{ streak.today_positive ? 'var(--success)' : 'var(--warning)' }};">
                    üî• {{ streak.current }}
                </div>
                <div style="font-size: 0.75rem; color: var(--text-secondary);">Jours positifs</div>
            </div>
            {% if streak.best > streak.current %}
            <div style="text-align: center;">
                <div style="font-size: 1.2rem; font-weight: 600; color: var(--text-secondary);">
                    ‚≠ê {{ streak.best }}
                </div>
                <div style="font-size: 0.75rem; color: var(--text-secondary);">Record</div>
            </div>
            {% endif %}
        </div>
        {% if next_milestone %}
        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--bg-secondary); text-align: center;">
            <div style="font-size: 0.8rem; color: var(--text-secondary);">
                {{ next_milestone.emoji }} Prochain palier : <strong>{{ next_milestone.days }}j</strong>
                <span style="color: var(--accent);">({{ next_milestone.days_remaining }}j restants)</span>
            </div>
        </div>
        {% endif %}
        {% endif %}

        <div class="rank-badge" style="margin-top: 15px;">{{ rank.rank }}</div>
        <div class="progress-bar">
            <div class="progress-fill" style="width: {{ rank.progress }}%"></div>
        </div>
        <div class="score-label" style="margin-top: 8px;">
            {{ rank.total_score }} / {{ rank.next_rank_threshold }} pts
        </div>
    </div>

    <!-- Compte √† rebours et paliers de points -->
    {% if next_cig_target %}
    <div class="card" style="padding: 15px; text-align: center;">
        {% if next_cig_target.status == 'active' or next_cig_target.status == 'exceeded' %}
            {% if next_cig_target.exceeded is defined and next_cig_target.exceeded %}
                <div style="color: var(--accent); font-size: 0.85rem; margin-bottom: 10px;">
                    ‚ö†Ô∏è Tu as d√©pass√© hier ({{ next_cig_target.yesterday_count }} clopes) - intervalle moyen utilis√©
                </div>
            {% endif %}
            <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 8px;">
                üéØ Intervalle cible : <strong>{{ next_cig_target.avg_interval|round }} min</strong>
            </div>
            <div id="points-display"
                 data-wake-minutes="{{ next_cig_target.wake_minutes }}"
                 data-target-minutes="{{ next_cig_target.target_minutes }}"
                 data-avg-interval="{{ next_cig_target.avg_interval }}">
                <div id="current-points-msg">Chargement...</div>
                <div id="next-tier-info" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--bg-lighter); display: none;">
                    <div id="next-tier-msg" style="color: var(--warning); font-size: 0.85rem;"></div>
                    <div id="countdown" style="font-size: 1.5rem; font-weight: 700; color: var(--warning); margin-top: 5px;"></div>
                </div>
            </div>
        {% elseif next_cig_target.status == 'no_wakeup' %}
            <div style="color: var(--warning); font-size: 0.9rem;">
                ‚è∞ {{ next_cig_target.message }}
            </div>
        {% elseif next_cig_target.status == 'first_day' %}
            <div style="color: var(--text-secondary); font-size: 0.9rem;">
                üìä {{ next_cig_target.message }}
            </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Bouton principal -->
    <button class="big-button" id="logBtn" onclick="logCigarette()">
        üö¨ J'ai fum√© une clope
    </button>

    <!-- Bouton ajout r√©troactif -->
    <button class="secondary-button" onclick="openModal()">
        ‚è∞ Ajouter une clope pass√©e
    </button>

    <!-- Stats du jour -->
    <div class="card">
        <h3 style="margin-bottom: 15px;">Aujourd'hui</h3>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" id="todayCount">{{ today_cigarettes|length }}</div>
                <div class="stat-label">Clopes</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ yesterday_count }}</div>
                <div class="stat-label">Hier</div>
            </div>
            <div class="stat-item">
                <div class="stat-value {{ (yesterday_count - today_cigarettes|length) > 0 ? 'positive' : ((yesterday_count - today_cigarettes|length) < 0 ? 'negative' : '') }}" style="color: {{ (yesterday_count - today_cigarettes|length) > 0 ? 'var(--success)' : ((yesterday_count - today_cigarettes|length) < 0 ? 'var(--accent)' : 'inherit') }}">
                    {{ yesterday_count - today_cigarettes|length >= 0 ? '+' : '' }}{{ yesterday_count - today_cigarettes|length }}
                </div>
                <div class="stat-label">Diff√©rence</div>
            </div>
            <div class="stat-item">
                {% if today_cigarettes|length > 0 %}
                    <div class="stat-value">{{ today_cigarettes|first.smokedAt|date('H:i') }}</div>
                {% else %}
                    <div class="stat-value">--</div>
                {% endif %}
                <div class="stat-label">1√®re clope</div>
            </div>
        </div>
    </div>

    <!-- D√©tail des points -->
    <div class="card">
        <h3 style="margin-bottom: 10px;">D√©tail des points</h3>
        <div class="score-breakdown">
            {% if daily_score.details.comparisons is defined %}
                {% for comp in daily_score.details.comparisons %}
                <div class="breakdown-item">
                    <span>
                        {% if comp.exceeded is defined and comp.exceeded %}‚ö†Ô∏è {% endif %}
                        Clope #{{ comp.index }} ({{ comp.diff > 0 ? '+' : '' }}{{ comp.diff }} min)
                    </span>
                    <span class="breakdown-score {{ comp.points > 0 ? 'positive' : 'negative' }}">
                        {{ comp.points > 0 ? '+' : '' }}{{ comp.points }}
                    </span>
                </div>
                {% endfor %}

                {# S√©parateur avant les bonus potentiels #}
                {% set has_potential_bonus = (daily_score.potential_reduction_bonus is defined and daily_score.potential_reduction_bonus > 0)
                    or (daily_score.potential_regularity_bonus is defined and daily_score.potential_regularity_bonus > 0)
                    or (daily_score.potential_weekly_bonus is defined and daily_score.potential_weekly_bonus > 0) %}

                {% if has_potential_bonus %}
                <div style="border-top: 1px dashed var(--bg-secondary); margin-top: 8px; padding-top: 8px;">
                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 6px; font-style: italic;">
                        ‚è≥ Bonus potentiels (acquis en fin de journ√©e)
                    </div>
                </div>
                {% endif %}

                {# Bonus de r√©duction vs hier (potentiel) #}
                {% if daily_score.potential_reduction_bonus is defined and daily_score.potential_reduction_bonus > 0 %}
                <div class="breakdown-item" style="opacity: 0.7;">
                    <span>üìâ R√©duction vs hier (-{{ daily_score.yesterday_count - daily_score.cigarette_count }})</span>
                    <span class="breakdown-score" style="color: var(--text-secondary);">+{{ daily_score.potential_reduction_bonus }}</span>
                </div>
                {% endif %}

                {# Bonus tendance hebdo (potentiel) #}
                {% if daily_score.potential_weekly_bonus is defined and daily_score.potential_weekly_bonus > 0 %}
                <div class="breakdown-item" style="opacity: 0.7;">
                    <span>üìä Tendance hebdo positive</span>
                    <span class="breakdown-score" style="color: var(--text-secondary);">+{{ daily_score.potential_weekly_bonus }}</span>
                </div>
                {% endif %}

                {# Bonus de r√©gularit√© (potentiel) #}
                {% if daily_score.potential_regularity_bonus is defined and daily_score.potential_regularity_bonus > 0 %}
                <div class="breakdown-item" style="opacity: 0.7;">
                    <span>‚≠ê Bonus r√©gularit√©</span>
                    <span class="breakdown-score" style="color: var(--text-secondary);">+{{ daily_score.potential_regularity_bonus }}</span>
                </div>
                {% endif %}
            {% elseif daily_score.details.message is defined %}
                <div class="breakdown-item">
                    <span>{{ daily_score.details.message }}</span>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Guide premier jour -->
    {% if next_cig_target.status == 'first_day' and today_cigarettes|length == 0 %}
    <div class="card" style="padding: 20px; background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary)); border: 2px dashed var(--accent);">
        <div style="text-align: center;">
            <div style="font-size: 2.5rem; margin-bottom: 10px;">üëã</div>
            <h3 style="margin-bottom: 10px; color: var(--text-primary);">Bienvenue !</h3>
            <p style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5;">
                C'est ton premier jour. Enregistre chaque cigarette pour commencer √† cr√©er ton historique.
            </p>
            <div style="margin-top: 15px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                    <strong style="color: var(--accent);">üí° Conseil :</strong> Les points seront calcul√©s √† partir de demain, une fois ton historique cr√©√©.
                </div>
            </div>
        </div>
    </div>
    {% elseif next_cig_target.status == 'first_day' and today_cigarettes|length > 0 and today_cigarettes|length < 3 %}
    <div class="card" style="padding: 15px; background: var(--bg-card);">
        <div style="display: flex; align-items: center; gap: 12px;">
            <div style="font-size: 1.8rem;">üìä</div>
            <div>
                <div style="font-weight: 600; color: var(--text-primary);">Continue comme √ßa !</div>
                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                    {{ today_cigarettes|length }} clope{{ today_cigarettes|length > 1 ? 's' : '' }} enregistr√©e{{ today_cigarettes|length > 1 ? 's' : '' }}. Demain, tu verras tes premiers points.
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Liste des clopes du jour -->
    <div class="card">
        <h3 style="margin-bottom: 10px;">Clopes du jour</h3>
        {% if today_cigarettes|length > 0 %}
            <ul class="cig-list" id="cigList">
                {% for cig in today_cigarettes %}
                    <li class="cig-item" data-id="{{ cig.id }}">
                        <div>
                            <span class="cig-time">{{ cig.smokedAt|date('H:i') }}</span>
                            {% if cig.isRetroactive %}
                                <span class="cig-badge">ajout√©e apr√®s</span>
                            {% endif %}
                        </div>
                        <button class="delete-btn" onclick="deleteCigarette({{ cig.id }})" aria-label="Supprimer la cigarette de {{ cig.smokedAt|date('H:i') }}"><span aria-hidden="true">‚úï</span></button>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">üéâ</div>
                <p>Aucune clope aujourd'hui !</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Modal ajout r√©troactif -->
<div class="modal" id="retroModal" role="dialog" aria-modal="true" aria-labelledby="retroModalTitle">
    <div class="modal-content">
        <h3 class="modal-title" id="retroModalTitle">Ajouter une clope pass√©e</h3>
        <div class="input-group">
            <label for="customTime">Date et heure</label>
            <input type="datetime-local" id="customTime" aria-describedby="customTimeHelp">
            <small id="customTimeHelp" style="color: var(--text-secondary); font-size: 0.75rem;">S√©lectionne la date et l'heure de la cigarette</small>
        </div>
        <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeModal()">Annuler</button>
            <button class="btn-confirm" onclick="logRetroactive()">Ajouter</button>
        </div>
    </div>
</div>

<!-- Modal r√©veil -->
<div class="modal" id="wakeUpModal" role="dialog" aria-modal="true" aria-labelledby="wakeUpModalTitle">
    <div class="modal-content">
        <h3 class="modal-title" id="wakeUpModalTitle">Heure de r√©veil</h3>
        <p id="wakeUpModalSubtitle" style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 15px; display: none;">
            Note ton heure de r√©veil pour un calcul pr√©cis des points
        </p>
        <div class="input-group">
            <label for="wakeTime">Heure</label>
            <input type="time" id="wakeTime" aria-required="true">
        </div>
        <div class="modal-buttons">
            <button class="btn-cancel" id="wakeUpCancelBtn" onclick="closeWakeUpModal()">Annuler</button>
            <button class="btn-confirm" onclick="saveWakeUp()">Enregistrer</button>
        </div>
    </div>
</div>

<!-- Modal confirmation suppression (accessible) -->
<div class="modal" id="confirmModal" role="alertdialog" aria-modal="true" aria-labelledby="confirmModalTitle" aria-describedby="confirmModalDesc">
    <div class="modal-content">
        <h3 class="modal-title" id="confirmModalTitle">Supprimer cette clope ?</h3>
        <p id="confirmModalDesc" style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 15px;">
            Cette action est irr√©versible.
        </p>
        <div class="modal-buttons">
            <button class="btn-cancel" id="confirmCancelBtn">Annuler</button>
            <button class="btn-confirm btn-danger" id="confirmOkBtn">Supprimer</button>
        </div>
    </div>
</div>

<script>
(function() {
    // Get CSRF token for secure requests
    var csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    // Set default datetime to now
    document.getElementById('customTime').value = new Date().toISOString().slice(0, 16);
    document.getElementById('wakeTime').value = new Date().toTimeString().slice(0, 5);

    // Ouvrir automatiquement le modal de r√©veil si pas encore renseign√© aujourd'hui
    {% if show_wakeup_modal %}
    document.getElementById('wakeUpModalTitle').textContent = 'Bonjour !';
    document.getElementById('wakeUpModalSubtitle').style.display = 'block';
    document.getElementById('wakeUpCancelBtn').style.display = 'none';
    document.getElementById('wakeUpModal').classList.add('active');
    {% endif %}

    // Calcul des points c√¥t√© client (m√™me logique que ScoringService - PAS DE TIMESTAMPS)
    var pointsDisplay = document.getElementById('points-display');
    if (pointsDisplay && pointsDisplay.dataset.wakeMinutes && pointsDisplay.dataset.targetMinutes) {
        var wakeMinutes = parseInt(pointsDisplay.dataset.wakeMinutes);
        var targetMinutes = parseFloat(pointsDisplay.dataset.targetMinutes);
        var avgInterval = parseFloat(pointsDisplay.dataset.avgInterval) || 60;

        // Scoring proportionnel √† l'intervalle, sans plafond
        // diff = intervalle ‚Üí 20 pts, diff = 2*intervalle ‚Üí 40 pts, etc.
        function getPointsForDiff(diff) {
            if (avgInterval <= 0) avgInterval = 60;
            var ratio = diff / avgInterval;

            if (diff > 0) {
                // Positif : 20 pts par intervalle, minimum 1
                return Math.max(1, Math.round(ratio * 20));
            } else if (diff === 0) {
                return -1;
            } else {
                // N√©gatif : malus proportionnel, plafonn√© √† -20
                return Math.max(-20, Math.round(ratio * 20));
            }
        }

        function updatePointsDisplay() {
            // Calcul bas√© sur l'heure locale UNIQUEMENT (pas de timestamp)
            var now = new Date();
            var nowMinutes = now.getHours() * 60 + now.getMinutes();
            var currentMinutesSinceWake = nowMinutes - wakeMinutes;
            var diff = currentMinutesSinceWake - targetMinutes;
            var currentPoints = getPointsForDiff(diff);

            var currentMsg = document.getElementById('current-points-msg');
            var nextInfo = document.getElementById('next-tier-info');
            var nextMsg = document.getElementById('next-tier-msg');
            var countdown = document.getElementById('countdown');

            // Afficher les points actuels
            if (currentPoints > 0) {
                currentMsg.innerHTML = '<span style="color: var(--success); font-size: 1.1rem; font-weight: 600;">Tu gagnerais +' + currentPoints + ' pts</span>';
            } else if (currentPoints === 0) {
                currentMsg.innerHTML = '<span style="color: var(--text-secondary); font-size: 1.1rem; font-weight: 600;">Tu gagnerais 0 pt</span>';
            } else {
                currentMsg.innerHTML = '<span style="color: var(--accent); font-size: 1.1rem; font-weight: 600;">Tu perdrais ' + Math.abs(currentPoints) + ' pts</span>';
            }

            // Calcul du prochain palier
            var pointStep = avgInterval / 20; // minutes pour gagner 1 pt de plus
            var minutesToNext, nextPoints, nextLabel;

            if (currentPoints < 1) {
                // En n√©gatif ou nul : afficher L'HEURE cible pour passer en positif (+1 pt)
                // +1 pt quand diff >= 0.5 * avgInterval / 20 = avgInterval / 40
                var diffForPositive = avgInterval / 40;
                minutesToNext = Math.ceil(diffForPositive - diff);
                nextPoints = 1;

                // Calculer l'heure cible
                var targetTime = new Date();
                targetTime.setMinutes(targetTime.getMinutes() + minutesToNext);
                var targetHour = targetTime.getHours().toString().padStart(2, '0');
                var targetMin = targetTime.getMinutes().toString().padStart(2, '0');

                nextMsg.innerHTML = 'Zone positive √† <strong>' + targetHour + ':' + targetMin + '</strong> ‚Üí +' + nextPoints + ' pt';
                countdown.textContent = targetHour + ':' + targetMin;
                countdown.style.color = 'var(--warning)';
                nextInfo.style.display = 'block';
            } else {
                // D√©j√† en positif : afficher le temps avant prochain palier
                var nextPointDiff = (currentPoints + 0.5) * avgInterval / 20;
                minutesToNext = Math.ceil(nextPointDiff - diff);
                if (minutesToNext <= 0) {
                    minutesToNext = Math.ceil(pointStep - ((diff - nextPointDiff) % pointStep));
                }
                nextPoints = currentPoints + 1;
                nextLabel = 'Prochain palier dans';

                if (minutesToNext > 0 && minutesToNext < 180) { // Max 3h affich√©es
                    nextMsg.innerHTML = nextLabel + ' <strong>' + minutesToNext + ' min</strong> ‚Üí +' + nextPoints + ' pts';

                    if (minutesToNext >= 60) {
                        var h = Math.floor(minutesToNext / 60);
                        var m = minutesToNext % 60;
                        countdown.textContent = h + 'h' + m.toString().padStart(2, '0');
                    } else {
                        countdown.textContent = minutesToNext + ' min';
                    }
                    countdown.style.color = 'var(--success)';
                    nextInfo.style.display = 'block';
                } else {
                    nextInfo.style.display = 'none';
                }
            }
        }

        updatePointsDisplay();
        setInterval(updatePointsDisplay, 60000);
    }

    window.logCigarette = function() {
        var btn = document.getElementById('logBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Enregistrement...';

        // Envoyer l'heure locale + offset timezone
        var now = new Date();
        var localTime = now.getFullYear() + '-' +
            String(now.getMonth() + 1).padStart(2, '0') + '-' +
            String(now.getDate()).padStart(2, '0') + ' ' +
            String(now.getHours()).padStart(2, '0') + ':' +
            String(now.getMinutes()).padStart(2, '0');
        var tzOffset = -now.getTimezoneOffset(); // En minutes, positif pour Est de UTC

        fetch('{{ path('app_log_cigarette') }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRF-Token': csrfToken
            },
            body: 'local_time=' + encodeURIComponent(localTime) + '&tz_offset=' + tzOffset
        })
        .then(function(response) {
            if (!response.ok) throw new Error('Network error');
            return response.json();
        })
        .then(function(data) {
            if (data.success) {
                // Feedback visuel enrichi avec points et streak
                var points = data.daily_score;
                var isPositive = points >= 0;
                var icon = isPositive ? '‚úÖ' : '‚ö†Ô∏è';
                var type = isPositive ? 'success' : 'warning';
                var streak = data.streak;

                // Message avec info streak si actif
                var message = 'Clope enregistr√©e √† ' + data.smoked_at;
                if (streak && streak.current > 0 && streak.today_positive) {
                    message += ' ‚Ä¢ üî• ' + streak.current + 'j';
                }

                showToast(message, {
                    type: type,
                    points: points,
                    icon: icon
                });

                // Afficher les nouveaux badges obtenus
                if (data.new_badges && data.new_badges.length > 0) {
                    data.new_badges.forEach(function(badge, index) {
                        setTimeout(function() {
                            showBadgeNotification(badge);
                        }, 1500 + (index * 2000)); // D√©calage pour afficher un par un
                    });
                }

                // Animation du bouton
                btn.classList.add('feedback-' + type);
                setTimeout(function() {
                    btn.classList.remove('feedback-success', 'feedback-warning');
                }, 600);

                document.getElementById('todayCount').textContent = data.today_count;
                // Ajouter la clope √† la liste sans reload
                addCigaretteToList(data.cigarette_id, data.smoked_at, data.is_retroactive);

                // Mettre √† jour le score affich√©
                updateScoreDisplay(points);

                // Mettre √† jour le streak affich√© si pr√©sent
                updateStreakDisplay(streak);
            }
        })
        .catch(function(err) {
            // Mode offline : ajouter √† la queue avec l'heure locale + timezone
            addToOfflineQueue('log_cigarette', { local_time: localTime, tz_offset: tzOffset });
            showToast('Clope enregistr√©e (hors-ligne)', { icon: 'üì¥' });
            // Incr√©menter visuellement le compteur
            var countEl = document.getElementById('todayCount');
            countEl.textContent = parseInt(countEl.textContent) + 1;
        })
        .finally(function() {
            btn.disabled = false;
            btn.innerHTML = 'üö¨ J\'ai fum√© une clope';
        });
    };

    // Mettre √† jour l'affichage du score
    function updateScoreDisplay(newScore) {
        var scoreEl = document.querySelector('.score-value');
        if (scoreEl) {
            // Animation du changement
            scoreEl.style.transform = 'scale(1.1)';
            scoreEl.style.transition = 'transform 0.2s ease';

            setTimeout(function() {
                scoreEl.textContent = (newScore > 0 ? '+' : '') + newScore;
                scoreEl.className = 'score-value' + (newScore < 0 ? ' negative' : '');
                scoreEl.style.transform = 'scale(1)';
            }, 100);
        }
    }

    // Afficher une notification de nouveau badge
    function showBadgeNotification(badge) {
        // Cr√©er l'overlay
        var overlay = document.createElement('div');
        overlay.className = 'badge-notification-overlay';
        overlay.innerHTML = '<div class="badge-notification">' +
            '<div class="badge-notification-icon">' + badge.icon + '</div>' +
            '<div class="badge-notification-title">Nouveau badge !</div>' +
            '<div class="badge-notification-name">' + badge.name + '</div>' +
            '<div class="badge-notification-desc">' + badge.description + '</div>' +
            '<button class="big-button" onclick="this.closest(\'.badge-notification-overlay\').remove()">Super !</button>' +
            '</div>';
        document.body.appendChild(overlay);

        // Animation d'entr√©e
        requestAnimationFrame(function() {
            overlay.classList.add('active');
        });

        // Auto-fermeture apr√®s 5 secondes
        setTimeout(function() {
            if (overlay.parentNode) {
                overlay.classList.remove('active');
                setTimeout(function() {
                    if (overlay.parentNode) overlay.remove();
                }, 300);
            }
        }, 5000);
    }

    // Mettre √† jour l'affichage du streak
    function updateStreakDisplay(streak) {
        if (!streak) return;

        // Chercher le conteneur du streak
        var streakContainer = document.querySelector('.score-display > div[style*="justify-content: center"]');
        if (!streakContainer) return;

        var streakValueEl = streakContainer.querySelector('div:first-child div:first-child');
        if (streakValueEl && streak.current > 0) {
            // Animation
            streakValueEl.style.transform = 'scale(1.2)';
            streakValueEl.style.transition = 'transform 0.3s ease';

            setTimeout(function() {
                streakValueEl.textContent = 'üî• ' + streak.current;
                streakValueEl.style.color = streak.today_positive ? 'var(--success)' : 'var(--warning)';
                streakValueEl.style.transform = 'scale(1)';
            }, 150);
        }
    }

    // Ajouter une cigarette √† la liste sans reload
    function addCigaretteToList(id, time, isRetroactive) {
        var list = document.getElementById('cigList');
        var emptyState = document.querySelector('.empty-state');

        // Supprimer l'√©tat vide s'il existe
        if (emptyState) {
            emptyState.parentElement.innerHTML = '<ul class="cig-list" id="cigList"></ul>';
            list = document.getElementById('cigList');
        }

        var li = document.createElement('li');
        li.className = 'cig-item';
        li.setAttribute('data-id', id);
        li.innerHTML = '<div><span class="cig-time">' + time + '</span>' +
            (isRetroactive ? '<span class="cig-badge">ajout√©e apr√®s</span>' : '') +
            '</div><button class="delete-btn" onclick="deleteCigarette(' + id + ')" aria-label="Supprimer la cigarette de ' + time + '"><span aria-hidden="true">‚úï</span></button>';
        list.appendChild(li);
    }

    window.openModal = function() {
        document.getElementById('retroModal').classList.add('active');
        document.getElementById('customTime').value = new Date().toISOString().slice(0, 16);
    };

    window.closeModal = function() {
        document.getElementById('retroModal').classList.remove('active');
    };

    window.logRetroactive = function() {
        var customTime = document.getElementById('customTime').value;
        // Convertir le format datetime-local (YYYY-MM-DDTHH:MM) en (YYYY-MM-DD HH:MM)
        var localTime = customTime.replace('T', ' ');
        var tzOffset = -new Date().getTimezoneOffset();

        fetch('{{ path('app_log_cigarette') }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRF-Token': csrfToken
            },
            body: 'local_time=' + encodeURIComponent(localTime) + '&tz_offset=' + tzOffset + '&is_retroactive=1'
        })
        .then(function(response) {
            if (!response.ok) throw new Error('Network error');
            return response.json();
        })
        .then(function(data) {
            if (data.success) {
                var points = data.daily_score;
                var isPositive = points >= 0;
                showToast('Clope ajout√©e √† ' + data.smoked_at, {
                    type: isPositive ? 'success' : 'warning',
                    points: points,
                    icon: '‚è∞'
                });
                closeModal();
                // Ajouter √† la liste sans reload
                addCigaretteToList(data.cigarette_id, data.smoked_at, true);
                var countEl = document.getElementById('todayCount');
                countEl.textContent = data.today_count;
                updateScoreDisplay(points);
            }
        })
        .catch(function(err) {
            addToOfflineQueue('log_cigarette', { local_time: localTime, tz_offset: tzOffset });
            showToast('Clope ajout√©e (hors-ligne)', { icon: 'üì¥' });
            closeModal();
        });
    };

    // Modal de confirmation accessible
    var pendingDeleteId = null;

    window.deleteCigarette = function(id) {
        pendingDeleteId = id;
        document.getElementById('confirmModal').classList.add('active');
        // Focus sur le bouton annuler pour accessibilit√©
        setTimeout(function() {
            document.getElementById('confirmCancelBtn').focus();
        }, 100);
    };

    function closeConfirmModal() {
        document.getElementById('confirmModal').classList.remove('active');
        pendingDeleteId = null;
    }

    function confirmDelete() {
        if (!pendingDeleteId) return;
        var id = pendingDeleteId;
        closeConfirmModal();

        fetch('/delete/' + id, {
            method: 'POST',
            headers: {
                'X-CSRF-Token': csrfToken
            }
        })
        .then(function(response) {
            if (!response.ok) throw new Error('Network error');
            return response.json();
        })
        .then(function(data) {
            if (data.success) {
                showToast('Clope supprim√©e', { type: 'success', icon: 'üóëÔ∏è' });
                document.querySelector('[data-id="' + id + '"]').remove();
                document.getElementById('todayCount').textContent = data.today_count;
                // V√©rifier si la liste est vide et afficher l'√©tat vide
                var list = document.getElementById('cigList');
                if (list && list.children.length === 0) {
                    list.parentElement.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üéâ</div><p>Aucune clope aujourd\'hui !</p></div>';
                }
            }
        })
        .catch(function(err) {
            showToast('Suppression impossible hors-ligne', { type: 'error', icon: 'üì¥' });
        });
    }

    // Event listeners pour la modal de confirmation
    document.getElementById('confirmCancelBtn').addEventListener('click', closeConfirmModal);
    document.getElementById('confirmOkBtn').addEventListener('click', confirmDelete);
    document.getElementById('confirmModal').addEventListener('click', function(e) {
        if (e.target === this) closeConfirmModal();
    });
    // Gestion du clavier (Escape pour fermer)
    document.getElementById('confirmModal').addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeConfirmModal();
    });

    window.openWakeUpModal = function() {
        document.getElementById('wakeUpModalTitle').textContent = 'Heure de r√©veil';
        document.getElementById('wakeUpModalSubtitle').style.display = 'none';
        document.getElementById('wakeUpCancelBtn').style.display = 'block';
        document.getElementById('wakeUpModal').classList.add('active');
        document.getElementById('wakeTime').value = new Date().toTimeString().slice(0, 5);
    };

    window.closeWakeUpModal = function() {
        document.getElementById('wakeUpModal').classList.remove('active');
    };

    window.saveWakeUp = function() {
        var wakeTime = document.getElementById('wakeTime').value;
        var tzOffset = -new Date().getTimezoneOffset();

        fetch('{{ path('app_log_wakeup') }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRF-Token': csrfToken
            },
            body: 'wake_time=' + encodeURIComponent(wakeTime) + '&tz_offset=' + tzOffset
        })
        .then(function(response) {
            if (!response.ok) throw new Error('Network error');
            return response.json();
        })
        .then(function(data) {
            if (data.success) {
                showToast('R√©veil enregistr√© √† ' + data.wake_time, { type: 'success', icon: '‚è∞' });
                document.getElementById('wakeupDisplay').textContent = data.wake_time;
                closeWakeUpModal();
                // Mettre √† jour le bouton sans reload
                var wakeBtn = document.querySelector('.card button.secondary-button');
                if (wakeBtn) {
                    wakeBtn.textContent = 'Modifier';
                    wakeBtn.style.background = '';
                }
            }
        })
        .catch(function(err) {
            addToOfflineQueue('log_wakeup', { wake_time: wakeTime, tz_offset: tzOffset });
            showToast('R√©veil enregistr√© (hors-ligne)', { icon: 'üì¥' });
            document.getElementById('wakeupDisplay').textContent = wakeTime;
            closeWakeUpModal();
        });
    };

    // Close modals on outside click
    document.getElementById('retroModal').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
    document.getElementById('wakeUpModal').addEventListener('click', function(e) {
        if (e.target === this) closeWakeUpModal();
    });

    // Gestion de l'indicateur offline
    var offlineIndicator = document.getElementById('offlineIndicator');
    function updateOnlineStatus() {
        if (!navigator.onLine) {
            offlineIndicator.style.display = 'inline-block';
        } else {
            offlineIndicator.style.display = 'none';
        }
    }
    updateOnlineStatus();
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
})();
</script>
{% endblock %}
