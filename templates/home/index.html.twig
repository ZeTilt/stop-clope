{% extends 'base.html.twig' %}

{% block title %}StopClope - Accueil{% endblock %}

{% block body %}
<div class="container">
    <header class="header">
        <h1>StopClope</h1>
        <div id="offlineIndicator" style="display: none; background: var(--warning); color: #000; padding: 5px 12px; border-radius: 12px; font-size: 0.75rem; margin-top: 5px;">
            Mode hors-ligne
        </div>
    </header>

    <!-- R√©veil du jour -->
    <div class="card" style="padding: 15px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <span style="color: var(--text-secondary); font-size: 0.85rem;">R√©veil</span>
                <div style="font-size: 1.3rem; font-weight: 600;" id="wakeupDisplay">
                    {% if today_wakeup %}
                        {{ today_wakeup.wakeTime|date('H:i') }}
                    {% else %}
                        --:--
                    {% endif %}
                </div>
            </div>
            <button class="secondary-button" style="width: auto; margin: 0; padding: 10px 15px;{% if not today_wakeup %} background: var(--accent);{% endif %}" onclick="openWakeUpModal()">
                {% if today_wakeup %}Modifier{% else %}Noter le r√©veil{% endif %}
            </button>
        </div>
    </div>

    <!-- Message d'encouragement -->
    {% if encouragement %}
    <div class="card" style="padding: 15px; text-align: center; background: {{ encouragement.type == 'success' ? 'linear-gradient(135deg, var(--success), #00ff88)' : 'linear-gradient(135deg, var(--warning), #ffdb4d)' }};">
        <span style="font-size: 1.5rem;">{{ encouragement.icon }}</span>
        <div style="color: #000; font-weight: 600; margin-top: 5px;">
            {{ encouragement.message }}
        </div>
    </div>
    {% endif %}

    <!-- Score du jour -->
    <div class="card score-display">
        <div class="score-value {{ daily_score.total_score < 0 ? 'negative' : '' }}">
            {{ daily_score.total_score > 0 ? '+' : '' }}{{ daily_score.total_score }}
        </div>
        <div class="score-label">Points aujourd'hui</div>
        <div class="rank-badge">{{ rank.rank }}</div>
        <div class="progress-bar">
            <div class="progress-fill" style="width: {{ rank.progress }}%"></div>
        </div>
        <div class="score-label" style="margin-top: 8px;">
            {{ rank.total_score }} / {{ rank.next_rank_threshold }} pts
        </div>
    </div>

    <!-- Compte √† rebours et paliers de points -->
    {% if next_cig_target %}
    <div class="card" style="padding: 15px; text-align: center;">
        {% if next_cig_target.status == 'active' or next_cig_target.status == 'exceeded' %}
            {% if next_cig_target.exceeded is defined and next_cig_target.exceeded %}
                <div style="color: var(--accent); font-size: 0.85rem; margin-bottom: 10px;">
                    ‚ö†Ô∏è Tu as d√©pass√© hier ({{ next_cig_target.yesterday_count }} clopes) - intervalle moyen utilis√©
                </div>
            {% endif %}
            <div id="points-display"
                 data-wake-minutes="{{ next_cig_target.wake_minutes }}"
                 data-target-minutes="{{ next_cig_target.target_minutes }}"
                 data-avg-interval="{{ next_cig_target.avg_interval }}">
                <div id="current-points-msg">Chargement...</div>
                <div id="next-tier-info" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--bg-lighter); display: none;">
                    <div id="next-tier-msg" style="color: var(--warning); font-size: 0.85rem;"></div>
                    <div id="countdown" style="font-size: 1.5rem; font-weight: 700; color: var(--warning); margin-top: 5px;"></div>
                </div>
            </div>
        {% elseif next_cig_target.status == 'no_wakeup' %}
            <div style="color: var(--warning); font-size: 0.9rem;">
                ‚è∞ {{ next_cig_target.message }}
            </div>
        {% elseif next_cig_target.status == 'first_day' %}
            <div style="color: var(--text-secondary); font-size: 0.9rem;">
                üìä {{ next_cig_target.message }}
            </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Bouton principal -->
    <button class="big-button" id="logBtn" onclick="logCigarette()">
        üö¨ J'ai fum√© une clope
    </button>

    <!-- Bouton ajout r√©troactif -->
    <button class="secondary-button" onclick="openModal()">
        ‚è∞ Ajouter une clope pass√©e
    </button>

    <!-- Stats du jour -->
    <div class="card">
        <h3 style="margin-bottom: 15px;">Aujourd'hui</h3>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" id="todayCount">{{ today_cigarettes|length }}</div>
                <div class="stat-label">Clopes</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ yesterday_count }}</div>
                <div class="stat-label">Hier</div>
            </div>
            <div class="stat-item">
                <div class="stat-value {{ (yesterday_count - today_cigarettes|length) > 0 ? 'positive' : ((yesterday_count - today_cigarettes|length) < 0 ? 'negative' : '') }}" style="color: {{ (yesterday_count - today_cigarettes|length) > 0 ? 'var(--success)' : ((yesterday_count - today_cigarettes|length) < 0 ? 'var(--accent)' : 'inherit') }}">
                    {{ yesterday_count - today_cigarettes|length >= 0 ? '+' : '' }}{{ yesterday_count - today_cigarettes|length }}
                </div>
                <div class="stat-label">Diff√©rence</div>
            </div>
            <div class="stat-item">
                {% if today_cigarettes|length > 0 %}
                    <div class="stat-value">{{ today_cigarettes|first.smokedAt|date('H:i') }}</div>
                {% else %}
                    <div class="stat-value">--</div>
                {% endif %}
                <div class="stat-label">1√®re clope</div>
            </div>
        </div>
    </div>

    <!-- D√©tail des points -->
    <div class="card">
        <h3 style="margin-bottom: 10px;">D√©tail des points</h3>
        <div class="score-breakdown">
            {% if daily_score.details.comparisons is defined %}
                {% for comp in daily_score.details.comparisons %}
                <div class="breakdown-item">
                    <span>
                        {% if comp.exceeded is defined and comp.exceeded %}‚ö†Ô∏è {% endif %}
                        Clope #{{ comp.index }} ({{ comp.diff > 0 ? '+' : '' }}{{ comp.diff }} min)
                    </span>
                    <span class="breakdown-score {{ comp.points > 0 ? 'positive' : 'negative' }}">
                        {{ comp.points > 0 ? '+' : '' }}{{ comp.points }}
                    </span>
                </div>
                {% endfor %}
            {% elseif daily_score.details.message is defined %}
                <div class="breakdown-item">
                    <span>{{ daily_score.details.message }}</span>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Liste des clopes du jour -->
    <div class="card">
        <h3 style="margin-bottom: 10px;">Clopes du jour</h3>
        {% if today_cigarettes|length > 0 %}
            <ul class="cig-list" id="cigList">
                {% for cig in today_cigarettes %}
                    <li class="cig-item" data-id="{{ cig.id }}">
                        <div>
                            <span class="cig-time">{{ cig.smokedAt|date('H:i') }}</span>
                            {% if cig.isRetroactive %}
                                <span class="cig-badge">ajout√©e apr√®s</span>
                            {% endif %}
                        </div>
                        <button class="delete-btn" onclick="deleteCigarette({{ cig.id }})">‚úï</button>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">üéâ</div>
                <p>Aucune clope aujourd'hui !</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Modal ajout r√©troactif -->
<div class="modal" id="retroModal">
    <div class="modal-content">
        <h3 class="modal-title">Ajouter une clope pass√©e</h3>
        <div class="input-group">
            <label for="customTime">Date et heure</label>
            <input type="datetime-local" id="customTime">
        </div>
        <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeModal()">Annuler</button>
            <button class="btn-confirm" onclick="logRetroactive()">Ajouter</button>
        </div>
    </div>
</div>

<!-- Modal r√©veil -->
<div class="modal" id="wakeUpModal">
    <div class="modal-content">
        <h3 class="modal-title" id="wakeUpModalTitle">Heure de r√©veil</h3>
        <p id="wakeUpModalSubtitle" style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 15px; display: none;">
            Note ton heure de r√©veil pour un calcul pr√©cis des points
        </p>
        <div class="input-group">
            <label for="wakeTime">Heure</label>
            <input type="time" id="wakeTime">
        </div>
        <div class="modal-buttons">
            <button class="btn-cancel" id="wakeUpCancelBtn" onclick="closeWakeUpModal()">Annuler</button>
            <button class="btn-confirm" onclick="saveWakeUp()">Enregistrer</button>
        </div>
    </div>
</div>

<script>
(function() {
    // Set default datetime to now
    document.getElementById('customTime').value = new Date().toISOString().slice(0, 16);
    document.getElementById('wakeTime').value = new Date().toTimeString().slice(0, 5);

    // Ouvrir automatiquement le modal de r√©veil si pas encore renseign√© aujourd'hui
    {% if show_wakeup_modal %}
    document.getElementById('wakeUpModalTitle').textContent = 'Bonjour !';
    document.getElementById('wakeUpModalSubtitle').style.display = 'block';
    document.getElementById('wakeUpCancelBtn').style.display = 'none';
    document.getElementById('wakeUpModal').classList.add('active');
    {% endif %}

    // Calcul des points c√¥t√© client (m√™me logique que ScoringService - PAS DE TIMESTAMPS)
    var pointsDisplay = document.getElementById('points-display');
    if (pointsDisplay && pointsDisplay.dataset.wakeMinutes && pointsDisplay.dataset.targetMinutes) {
        var wakeMinutes = parseInt(pointsDisplay.dataset.wakeMinutes);
        var targetMinutes = parseFloat(pointsDisplay.dataset.targetMinutes);
        var avgInterval = parseFloat(pointsDisplay.dataset.avgInterval) || 60;

        // Scoring proportionnel √† l'intervalle, sans plafond
        // diff = intervalle ‚Üí 10 pts, diff = 2*intervalle ‚Üí 20 pts, etc.
        function getPointsForDiff(diff) {
            if (avgInterval <= 0) avgInterval = 60;
            var ratio = diff / avgInterval;

            if (diff > 0) {
                // Positif : 10 pts par intervalle, minimum 1
                return Math.max(1, Math.round(ratio * 10));
            } else if (diff === 0) {
                return -1;
            } else {
                // N√©gatif : malus proportionnel, plafonn√© √† -10
                return Math.max(-10, Math.round(ratio * 10));
            }
        }

        function updatePointsDisplay() {
            // Calcul bas√© sur l'heure locale UNIQUEMENT (pas de timestamp)
            var now = new Date();
            var nowMinutes = now.getHours() * 60 + now.getMinutes();
            var currentMinutesSinceWake = nowMinutes - wakeMinutes;
            var diff = currentMinutesSinceWake - targetMinutes;
            var currentPoints = getPointsForDiff(diff);

            var currentMsg = document.getElementById('current-points-msg');
            var nextInfo = document.getElementById('next-tier-info');
            var nextMsg = document.getElementById('next-tier-msg');
            var countdown = document.getElementById('countdown');

            // Afficher les points actuels
            if (currentPoints > 0) {
                currentMsg.innerHTML = '<span style="color: var(--success); font-size: 1.1rem; font-weight: 600;">Tu gagnerais +' + currentPoints + ' pts</span>';
            } else if (currentPoints === 0) {
                currentMsg.innerHTML = '<span style="color: var(--text-secondary); font-size: 1.1rem; font-weight: 600;">Tu gagnerais 0 pt</span>';
            } else {
                currentMsg.innerHTML = '<span style="color: var(--accent); font-size: 1.1rem; font-weight: 600;">Tu perdrais ' + Math.abs(currentPoints) + ' pts</span>';
            }

            // Prochain palier : +10 pts dans (intervalle - diff) minutes
            var nextPoints = currentPoints + 10;
            var minutesToNext = Math.ceil(avgInterval - (diff % avgInterval));
            if (minutesToNext <= 0) minutesToNext = Math.ceil(avgInterval);

            if (minutesToNext > 0 && minutesToNext < 180) { // Max 3h affich√©es
                nextMsg.innerHTML = 'Attends ' + minutesToNext + ' min pour +' + nextPoints + ' pts <span style="color: var(--success);">(+10 de plus)</span>';

                if (minutesToNext >= 60) {
                    var h = Math.floor(minutesToNext / 60);
                    var m = minutesToNext % 60;
                    countdown.textContent = h + 'h' + m.toString().padStart(2, '0');
                } else {
                    countdown.textContent = minutesToNext + ' min';
                }
                nextInfo.style.display = 'block';
            } else {
                nextInfo.style.display = 'none';
            }
        }

        updatePointsDisplay();
        setInterval(updatePointsDisplay, 60000);
    }

    window.logCigarette = function() {
        var btn = document.getElementById('logBtn');
        btn.disabled = true;
        btn.textContent = '‚è≥ Enregistrement...';

        // Envoyer l'heure locale + offset timezone
        var now = new Date();
        var localTime = now.getFullYear() + '-' +
            String(now.getMonth() + 1).padStart(2, '0') + '-' +
            String(now.getDate()).padStart(2, '0') + ' ' +
            String(now.getHours()).padStart(2, '0') + ':' +
            String(now.getMinutes()).padStart(2, '0');
        var tzOffset = -now.getTimezoneOffset(); // En minutes, positif pour Est de UTC

        fetch('{{ path('app_log_cigarette') }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'local_time=' + encodeURIComponent(localTime) + '&tz_offset=' + tzOffset
        })
        .then(function(response) {
            if (!response.ok) throw new Error('Network error');
            return response.json();
        })
        .then(function(data) {
            if (data.success) {
                showToast('Clope enregistr√©e √† ' + data.smoked_at);
                document.getElementById('todayCount').textContent = data.today_count;
                setTimeout(function() { location.reload(); }, 1000);
            }
        })
        .catch(function(err) {
            // Mode offline : ajouter √† la queue avec l'heure locale + timezone
            addToOfflineQueue('log_cigarette', { local_time: localTime, tz_offset: tzOffset });
            showToast('Clope enregistr√©e (hors-ligne)');
            // Incr√©menter visuellement le compteur
            var countEl = document.getElementById('todayCount');
            countEl.textContent = parseInt(countEl.textContent) + 1;
        })
        .finally(function() {
            btn.disabled = false;
            btn.textContent = 'üö¨ J\'ai fum√© une clope';
        });
    };

    window.openModal = function() {
        document.getElementById('retroModal').classList.add('active');
        document.getElementById('customTime').value = new Date().toISOString().slice(0, 16);
    };

    window.closeModal = function() {
        document.getElementById('retroModal').classList.remove('active');
    };

    window.logRetroactive = function() {
        var customTime = document.getElementById('customTime').value;
        // Convertir le format datetime-local (YYYY-MM-DDTHH:MM) en (YYYY-MM-DD HH:MM)
        var localTime = customTime.replace('T', ' ');
        var tzOffset = -new Date().getTimezoneOffset();

        fetch('{{ path('app_log_cigarette') }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'local_time=' + encodeURIComponent(localTime) + '&tz_offset=' + tzOffset + '&is_retroactive=1'
        })
        .then(function(response) {
            if (!response.ok) throw new Error('Network error');
            return response.json();
        })
        .then(function(data) {
            if (data.success) {
                showToast('Clope ajout√©e √† ' + data.smoked_at);
                closeModal();
                setTimeout(function() { location.reload(); }, 1000);
            }
        })
        .catch(function(err) {
            addToOfflineQueue('log_cigarette', { local_time: localTime, tz_offset: tzOffset });
            showToast('Clope ajout√©e (hors-ligne)');
            closeModal();
        });
    };

    window.deleteCigarette = function(id) {
        if (!confirm('Supprimer cette clope ?')) return;

        fetch('/delete/' + id, {
            method: 'POST'
        })
        .then(function(response) {
            if (!response.ok) throw new Error('Network error');
            return response.json();
        })
        .then(function(data) {
            if (data.success) {
                showToast('Clope supprim√©e');
                document.querySelector('[data-id="' + id + '"]').remove();
                document.getElementById('todayCount').textContent = data.today_count;
                setTimeout(function() { location.reload(); }, 1000);
            }
        })
        .catch(function(err) {
            showToast('Suppression impossible hors-ligne');
        });
    };

    window.openWakeUpModal = function() {
        document.getElementById('wakeUpModalTitle').textContent = 'Heure de r√©veil';
        document.getElementById('wakeUpModalSubtitle').style.display = 'none';
        document.getElementById('wakeUpCancelBtn').style.display = 'block';
        document.getElementById('wakeUpModal').classList.add('active');
        document.getElementById('wakeTime').value = new Date().toTimeString().slice(0, 5);
    };

    window.closeWakeUpModal = function() {
        document.getElementById('wakeUpModal').classList.remove('active');
    };

    window.saveWakeUp = function() {
        var wakeTime = document.getElementById('wakeTime').value;
        var tzOffset = -new Date().getTimezoneOffset();

        fetch('{{ path('app_log_wakeup') }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'wake_time=' + encodeURIComponent(wakeTime) + '&tz_offset=' + tzOffset
        })
        .then(function(response) {
            if (!response.ok) throw new Error('Network error');
            return response.json();
        })
        .then(function(data) {
            if (data.success) {
                showToast('R√©veil enregistr√© √† ' + data.wake_time);
                document.getElementById('wakeupDisplay').textContent = data.wake_time;
                closeWakeUpModal();
                setTimeout(function() { location.reload(); }, 1000);
            }
        })
        .catch(function(err) {
            addToOfflineQueue('log_wakeup', { wake_time: wakeTime, tz_offset: tzOffset });
            showToast('R√©veil enregistr√© (hors-ligne)');
            document.getElementById('wakeupDisplay').textContent = wakeTime;
            closeWakeUpModal();
        });
    };

    // Close modals on outside click
    document.getElementById('retroModal').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
    document.getElementById('wakeUpModal').addEventListener('click', function(e) {
        if (e.target === this) closeWakeUpModal();
    });

    // Gestion de l'indicateur offline
    var offlineIndicator = document.getElementById('offlineIndicator');
    function updateOnlineStatus() {
        if (!navigator.onLine) {
            offlineIndicator.style.display = 'inline-block';
        } else {
            offlineIndicator.style.display = 'none';
        }
    }
    updateOnlineStatus();
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
})();
</script>
{% endblock %}
