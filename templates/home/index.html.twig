{% extends 'base.html.twig' %}

{% block title %}StopClope - Accueil{% endblock %}

{% block body %}
<div class="container">
    <header class="header">
        <h1>StopClope</h1>
        <div id="offlineIndicator" style="display: none; background: var(--warning); color: #000; padding: 5px 12px; border-radius: 12px; font-size: 0.75rem; margin-top: 5px;">
            Mode hors-ligne
        </div>
    </header>

    <!-- R√©veil du jour -->
    <div class="card" style="padding: 15px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <span style="color: var(--text-secondary); font-size: 0.85rem;">R√©veil</span>
                <div style="font-size: 1.3rem; font-weight: 600;" id="wakeupDisplay">
                    {% if today_wakeup %}
                        {{ today_wakeup.wakeTime|date('H:i') }}
                    {% else %}
                        --:--
                    {% endif %}
                </div>
            </div>
            <button class="secondary-button" style="width: auto; margin: 0; padding: 10px 15px;{% if not today_wakeup %} background: var(--accent);{% endif %}" onclick="openWakeUpModal()">
                {% if today_wakeup %}Modifier{% else %}Noter le r√©veil{% endif %}
            </button>
        </div>
    </div>

    <!-- Message d'encouragement -->
    {% if encouragement %}
    <div class="card" style="padding: 15px; text-align: center; background: {{ encouragement.type == 'success' ? 'linear-gradient(135deg, var(--success), #00ff88)' : 'linear-gradient(135deg, var(--warning), #ffdb4d)' }};">
        <span style="font-size: 1.5rem;">{{ encouragement.icon }}</span>
        <div style="color: #000; font-weight: 600; margin-top: 5px;">
            {{ encouragement.message }}
        </div>
    </div>
    {% endif %}

    <!-- Score du jour -->
    <div class="card score-display">
        <div class="score-value {{ daily_score.total_score < 0 ? 'negative' : '' }}">
            {{ daily_score.total_score > 0 ? '+' : '' }}{{ daily_score.total_score }}
        </div>
        <div class="score-label">Points aujourd'hui</div>
        <div class="rank-badge">{{ rank.rank }}</div>
        <div class="progress-bar">
            <div class="progress-fill" style="width: {{ rank.progress }}%"></div>
        </div>
        <div class="score-label" style="margin-top: 8px;">
            {{ rank.total_score }} / {{ rank.next_rank_threshold }} pts
        </div>
    </div>

    <!-- Compte √† rebours et paliers de points -->
    {% if next_cig_target %}
    <div class="card" style="padding: 15px; text-align: center;">
        {% if next_cig_target.status == 'waiting' %}
            <div style="color: var(--accent); font-size: 0.85rem;">Pour ne pas perdre de points</div>
            <div id="countdown" style="font-size: 2rem; font-weight: 700; color: var(--accent);" data-seconds="{{ next_cig_target.seconds_remaining }}">
                {{ next_cig_target.message }}
            </div>
            {% if next_cig_target.current_penalty %}
                <div style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 5px;">
                    Si tu fumes maintenant : {{ next_cig_target.current_penalty }} pts
                </div>
            {% endif %}
        {% elseif next_cig_target.status == 'bonus' %}
            <div style="color: var(--warning); font-size: 0.85rem;">Pour gagner {{ next_cig_target.next_tier.label }}</div>
            <div id="countdown" style="font-size: 2rem; font-weight: 700; color: var(--warning);" data-seconds="{{ next_cig_target.seconds_remaining }}">
                Encore {{ (next_cig_target.seconds_remaining / 60)|round }}min
            </div>
            <div style="color: var(--success); font-size: 0.85rem; margin-top: 5px;">
                Actuellement : {{ next_cig_target.current_label }}
            </div>
        {% elseif next_cig_target.status == 'max_bonus' %}
            <div style="color: var(--success); font-size: 1.3rem; font-weight: 700;">
                üèÜ {{ next_cig_target.message }}
            </div>
        {% elseif next_cig_target.status == 'ok' %}
            <div style="color: var(--success); font-size: 1.1rem; font-weight: 600;">
                ‚úì {{ next_cig_target.message }}
            </div>
        {% elseif next_cig_target.status == 'ahead' %}
            <div style="color: var(--success); font-size: 1.1rem; font-weight: 600;">
                üéâ {{ next_cig_target.message }}
            </div>
        {% elseif next_cig_target.status == 'first_day' %}
            <div style="color: var(--text-secondary); font-size: 0.9rem;">
                üìä {{ next_cig_target.message }}
            </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Bouton principal -->
    <button class="big-button" id="logBtn" onclick="logCigarette()">
        üö¨ J'ai fum√© une clope
    </button>

    <!-- Bouton ajout r√©troactif -->
    <button class="secondary-button" onclick="openModal()">
        ‚è∞ Ajouter une clope pass√©e
    </button>

    <!-- Stats du jour -->
    <div class="card">
        <h3 style="margin-bottom: 15px;">Aujourd'hui</h3>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" id="todayCount">{{ today_cigarettes|length }}</div>
                <div class="stat-label">Clopes</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ yesterday_count }}</div>
                <div class="stat-label">Hier</div>
            </div>
            <div class="stat-item">
                <div class="stat-value {{ (yesterday_count - today_cigarettes|length) > 0 ? 'positive' : ((yesterday_count - today_cigarettes|length) < 0 ? 'negative' : '') }}" style="color: {{ (yesterday_count - today_cigarettes|length) > 0 ? 'var(--success)' : ((yesterday_count - today_cigarettes|length) < 0 ? 'var(--accent)' : 'inherit') }}">
                    {{ yesterday_count - today_cigarettes|length >= 0 ? '+' : '' }}{{ yesterday_count - today_cigarettes|length }}
                </div>
                <div class="stat-label">Diff√©rence</div>
            </div>
            <div class="stat-item">
                {% if today_cigarettes|length > 0 %}
                    <div class="stat-value">{{ today_cigarettes|first.smokedAt|date('H:i') }}</div>
                {% else %}
                    <div class="stat-value">--</div>
                {% endif %}
                <div class="stat-label">1√®re clope</div>
            </div>
        </div>
    </div>

    <!-- D√©tail des points -->
    <div class="card">
        <h3 style="margin-bottom: 10px;">D√©tail des points</h3>
        <div class="score-breakdown">
            {% for key, detail in daily_score.details %}
                <div class="breakdown-item">
                    <span>{{ detail.label }}</span>
                    <span class="breakdown-score {{ detail.score > 0 ? 'positive' : (detail.score < 0 ? 'negative' : '') }}">
                        {{ detail.score > 0 ? '+' : '' }}{{ detail.score }}
                    </span>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Liste des clopes du jour -->
    <div class="card">
        <h3 style="margin-bottom: 10px;">Clopes du jour</h3>
        {% if today_cigarettes|length > 0 %}
            <ul class="cig-list" id="cigList">
                {% for cig in today_cigarettes %}
                    <li class="cig-item" data-id="{{ cig.id }}">
                        <div>
                            <span class="cig-time">{{ cig.smokedAt|date('H:i') }}</span>
                            {% if cig.isRetroactive %}
                                <span class="cig-badge">ajout√©e apr√®s</span>
                            {% endif %}
                        </div>
                        <button class="delete-btn" onclick="deleteCigarette({{ cig.id }})">‚úï</button>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">üéâ</div>
                <p>Aucune clope aujourd'hui !</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Modal ajout r√©troactif -->
<div class="modal" id="retroModal">
    <div class="modal-content">
        <h3 class="modal-title">Ajouter une clope pass√©e</h3>
        <div class="input-group">
            <label for="customTime">Date et heure</label>
            <input type="datetime-local" id="customTime">
        </div>
        <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeModal()">Annuler</button>
            <button class="btn-confirm" onclick="logRetroactive()">Ajouter</button>
        </div>
    </div>
</div>

<!-- Modal r√©veil -->
<div class="modal" id="wakeUpModal">
    <div class="modal-content">
        <h3 class="modal-title" id="wakeUpModalTitle">Heure de r√©veil</h3>
        <p id="wakeUpModalSubtitle" style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 15px; display: none;">
            Note ton heure de r√©veil pour un calcul pr√©cis des points
        </p>
        <div class="input-group">
            <label for="wakeTime">Heure</label>
            <input type="time" id="wakeTime">
        </div>
        <div class="modal-buttons">
            <button class="btn-cancel" id="wakeUpCancelBtn" onclick="closeWakeUpModal()">Annuler</button>
            <button class="btn-confirm" onclick="saveWakeUp()">Enregistrer</button>
        </div>
    </div>
</div>

<script>
    // Set default datetime to now
    document.getElementById('customTime').value = new Date().toISOString().slice(0, 16);
    document.getElementById('wakeTime').value = new Date().toTimeString().slice(0, 5);

    // Ouvrir automatiquement le modal de r√©veil si pas encore renseign√© aujourd'hui
    {% if show_wakeup_modal %}
    (function() {
        document.getElementById('wakeUpModalTitle').textContent = 'Bonjour !';
        document.getElementById('wakeUpModalSubtitle').style.display = 'block';
        document.getElementById('wakeUpCancelBtn').style.display = 'none';
        document.getElementById('wakeUpModal').classList.add('active');
    })();
    {% endif %}

    // Compte √† rebours en temps r√©el
    const countdownEl = document.getElementById('countdown');
    if (countdownEl && countdownEl.dataset.seconds) {
        let seconds = parseInt(countdownEl.dataset.seconds);

        const updateCountdown = () => {
            if (seconds <= 0) {
                countdownEl.textContent = '‚úì Tu peux fumer sans p√©nalit√©';
                countdownEl.style.color = 'var(--success)';
                return;
            }

            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;

            countdownEl.textContent = `${hours}h${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            seconds--;
        };

        updateCountdown();
        setInterval(updateCountdown, 1000);
    }

    function logCigarette() {
        const btn = document.getElementById('logBtn');
        btn.disabled = true;
        btn.textContent = '‚è≥ Enregistrement...';

        // Envoyer l'heure locale du client
        const now = new Date();
        const localTime = now.getFullYear() + '-' +
            String(now.getMonth() + 1).padStart(2, '0') + '-' +
            String(now.getDate()).padStart(2, '0') + 'T' +
            String(now.getHours()).padStart(2, '0') + ':' +
            String(now.getMinutes()).padStart(2, '0');

        fetch('{{ path('app_log_cigarette') }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'custom_time=' + encodeURIComponent(localTime)
        })
        .then(response => {
            if (!response.ok) throw new Error('Network error');
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showToast('Clope enregistr√©e √† ' + data.smoked_at);
                document.getElementById('todayCount').textContent = data.today_count;
                setTimeout(() => location.reload(), 1000);
            }
        })
        .catch(err => {
            // Mode offline : ajouter √† la queue avec l'heure locale
            addToOfflineQueue('log_cigarette', { custom_time: localTime });
            showToast('Clope enregistr√©e (hors-ligne)');
            // Incr√©menter visuellement le compteur
            const countEl = document.getElementById('todayCount');
            countEl.textContent = parseInt(countEl.textContent) + 1;
        })
        .finally(() => {
            btn.disabled = false;
            btn.textContent = 'üö¨ J\'ai fum√© une clope';
        });
    }

    function openModal() {
        document.getElementById('retroModal').classList.add('active');
        document.getElementById('customTime').value = new Date().toISOString().slice(0, 16);
    }

    function closeModal() {
        document.getElementById('retroModal').classList.remove('active');
    }

    function logRetroactive() {
        const customTime = document.getElementById('customTime').value;

        fetch('{{ path('app_log_cigarette') }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'custom_time=' + encodeURIComponent(customTime) + '&is_retroactive=1'
        })
        .then(response => {
            if (!response.ok) throw new Error('Network error');
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showToast('Clope ajout√©e √† ' + data.smoked_at);
                closeModal();
                setTimeout(() => location.reload(), 1000);
            }
        })
        .catch(err => {
            addToOfflineQueue('log_cigarette', { custom_time: customTime });
            showToast('Clope ajout√©e (hors-ligne)');
            closeModal();
        });
    }

    function deleteCigarette(id) {
        if (!confirm('Supprimer cette clope ?')) return;

        fetch('/delete/' + id, {
            method: 'POST'
        })
        .then(response => {
            if (!response.ok) throw new Error('Network error');
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showToast('Clope supprim√©e');
                document.querySelector('[data-id="' + id + '"]').remove();
                document.getElementById('todayCount').textContent = data.today_count;
                setTimeout(() => location.reload(), 1000);
            }
        })
        .catch(err => {
            showToast('Suppression impossible hors-ligne');
        });
    }

    function openWakeUpModal() {
        document.getElementById('wakeUpModalTitle').textContent = 'Heure de r√©veil';
        document.getElementById('wakeUpModalSubtitle').style.display = 'none';
        document.getElementById('wakeUpCancelBtn').style.display = 'block';
        document.getElementById('wakeUpModal').classList.add('active');
        document.getElementById('wakeTime').value = new Date().toTimeString().slice(0, 5);
    }

    function closeWakeUpModal() {
        document.getElementById('wakeUpModal').classList.remove('active');
    }

    function saveWakeUp() {
        const wakeTime = document.getElementById('wakeTime').value;

        fetch('{{ path('app_log_wakeup') }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'wake_time=' + encodeURIComponent(wakeTime)
        })
        .then(response => {
            if (!response.ok) throw new Error('Network error');
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showToast('R√©veil enregistr√© √† ' + data.wake_time);
                document.getElementById('wakeupDisplay').textContent = data.wake_time;
                closeWakeUpModal();
                setTimeout(() => location.reload(), 1000);
            }
        })
        .catch(err => {
            addToOfflineQueue('log_wakeup', { wake_time: wakeTime });
            showToast('R√©veil enregistr√© (hors-ligne)');
            document.getElementById('wakeupDisplay').textContent = wakeTime;
            closeWakeUpModal();
        });
    }

    // Close modals on outside click
    document.getElementById('retroModal').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
    document.getElementById('wakeUpModal').addEventListener('click', function(e) {
        if (e.target === this) closeWakeUpModal();
    });

    // Gestion de l'indicateur offline
    const offlineIndicator = document.getElementById('offlineIndicator');
    function updateOnlineStatus() {
        if (!navigator.onLine) {
            offlineIndicator.style.display = 'inline-block';
        } else {
            offlineIndicator.style.display = 'none';
        }
    }
    updateOnlineStatus();
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
</script>
{% endblock %}
